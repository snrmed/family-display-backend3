<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>kin;D Display Designer</title>
<style>
/* CSS Variables */
:root{
  --panel:#0f0f11;
  --panel2:#1a1a1e;
  --text:#eee;
  --muted:#9aa0a6;
  --accent:#00d9b8;
  --brand:#00d9b8;
  --border:#2a2a2e;
  --hover:#242428;
}

/* Base Styles */
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  background:#0a0a0c;
  color:var(--text);
  font-family:system-ui,'Segoe UI',sans-serif;
  overflow:hidden;
  font-size:14px;
}

/* Grid Layout */
.app{
  display:grid;
  grid-template-columns:1fr 380px;
  grid-template-rows:auto 1fr 40px;
  gap:0;
  height:100vh;
}

/* Header */
header{
  grid-column:1/3;
  background:linear-gradient(135deg,#0f0f11 0%,#1a1a1e 100%);
  border-bottom:1px solid var(--border);
  padding:12px 20px;
  display:flex;
  align-items:center;
  gap:12px;
  box-shadow:0 2px 8px rgba(0,0,0,.3);
  flex-wrap:wrap;
}
.brand{
  font-size:20px;
  font-weight:700;
  color:var(--brand);
  letter-spacing:-0.5px;
}
.brand-tagline{
  color:var(--muted);
  font-size:11px;
  font-weight:300;
  text-transform:uppercase;
  letter-spacing:1px;
  margin-right:auto;
}
header .divider{
  width:1px;
  height:24px;
  background:var(--border);
  margin:0 4px;
}

/* Canvas Stage */
.stage-wrap{
  grid-row:2;
  grid-column:1;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  overflow:auto;
  padding:20px;
  background:#0a0a0c;
}
#zoomStage{
  transform-origin:top left;
  display:inline-block;
  transition:transform 0.2s ease;
}
#canvas{
  position:relative;
  width:800px;
  height:480px;
  border:1px solid #333;
  border-radius:8px;
  overflow:hidden;
  background:#111;
  box-shadow:0 8px 32px rgba(0,0,0,.6);
}
#bg{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  z-index:0;
}

/* Grid Overlay */
.grid-overlay{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:1;
  display:none;
}
.grid-overlay.active{display:block}
.grid-overlay line{
  stroke:var(--brand);
  stroke-width:0.5;
  opacity:0.3;
}

/* Elements */
.el{
  position:absolute;
  user-select:none;
  z-index:5;
  cursor:move;
  transition:outline 0.15s ease;
}
.box{
  background:rgba(255,255,255,.16);
  border:1px solid rgba(255,255,255,.45);
  border-radius:12px;
  padding:10px;
}
.text,.icon{
  background:transparent;
  border:none;
  padding:0;
  line-height:1.15;
  color:#000;
  white-space:pre-wrap;
  display:flex;
  align-items:center;
  justify-content:center;
}
.selected{
  outline:2px solid var(--brand);
  outline-offset:2px;
  animation:pulse 2s ease-in-out infinite;
}
@keyframes pulse{
  0%,100%{outline-color:var(--brand)}
  50%{outline-color:rgba(0,217,184,0.5)}
}

/* Resize handle */
.resize-handle{
  position:absolute;
  bottom:-4px;
  right:-4px;
  width:12px;
  height:12px;
  background:var(--brand);
  border-radius:50%;
  cursor:nwse-resize;
  z-index:10;
  box-shadow:0 2px 4px rgba(0,0,0,0.3);
  display:none;
}
.selected .resize-handle{
  display:block;
}

/* Sidebar */
.sidebar{
  grid-row:2/4;
  grid-column:2;
  background:var(--panel);
  border-left:1px solid var(--border);
  display:flex;
  flex-direction:column;
  overflow:auto;
}
.panel{
  padding:16px;
  border-bottom:1px solid var(--border);
  background:var(--panel2);
}
.panel:hover{background:#1c1c20}
.panel h3{
  margin:0 0 12px 0;
  font-size:13px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:0.5px;
  color:var(--brand);
}
.row{
  display:flex;
  gap:8px;
  align-items:center;
  margin:8px 0;
  flex-wrap:wrap;
}
label{
  color:var(--muted);
  font-size:12px;
  font-weight:500;
}

/* Form Controls */
button,input,select{
  background:var(--hover);
  color:#eee;
  border:1px solid var(--border);
  border-radius:6px;
  padding:8px 12px;
  font-size:13px;
  font-family:inherit;
  transition:all 0.15s ease;
  cursor:pointer;
}
button:hover{
  background:#2e2e32;
  border-color:var(--brand);
}
button:active{transform:scale(0.98)}
button.primary{
  background:var(--brand);
  color:#000;
  font-weight:600;
  border-color:var(--brand);
}
button.primary:hover{
  background:#00ecc7;
  box-shadow:0 0 12px rgba(0,217,184,0.3);
}
button:disabled{
  opacity:0.4;
  cursor:not-allowed;
}
button:disabled:hover{
  background:var(--hover);
  border-color:var(--border);
  transform:none;
}
.tiny{font-size:11px;padding:6px 10px}
input[type="range"]{width:120px}
input[type="text"],input[type="password"]{min-width:100px}

/* Status Bar */
.status-bar{
  grid-row:3;
  grid-column:1;
  background:var(--panel);
  border-top:1px solid var(--border);
  padding:0 20px;
  display:flex;
  align-items:center;
  gap:20px;
  font-size:11px;
  color:var(--muted);
}
.status-item{
  display:flex;
  align-items:center;
  gap:6px;
}
.status-dot{
  width:6px;
  height:6px;
  border-radius:50%;
  background:var(--brand);
  animation:blink 2s ease-in-out infinite;
}
@keyframes blink{
  0%,100%{opacity:1}
  50%{opacity:0.3}
}
.kbd{
  background:#1a1a1e;
  border:1px solid var(--border);
  border-radius:4px;
  padding:2px 6px;
  font-family:monospace;
  font-size:10px;
}

/* Value Pills */
.value-pill{
  background:#222;
  border:1px solid var(--border);
  border-radius:6px;
  padding:4px 8px;
  font-size:11px;
  color:var(--brand);
  font-weight:600;
  font-family:monospace;
}

/* Gallery Overlay */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  backdrop-filter:blur(8px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
  animation:fadeIn 0.3s ease;
}
@keyframes fadeIn{
  from{opacity:0}
  to{opacity:1}
}
.gallery{
  background:linear-gradient(135deg,#0f0f11 0%,#1a1a1e 100%);
  border:1px solid var(--border);
  border-radius:16px;
  padding:24px;
  max-width:1200px;
  width:92vw;
  max-height:88vh;
  overflow:auto;
  box-shadow:0 32px 64px rgba(0,0,0,.8);
  animation:slideUp 0.3s ease;
}
@keyframes slideUp{
  from{transform:translateY(20px);opacity:0}
  to{transform:translateY(0);opacity:1}
}
.gallery h2{
  margin:0 0 8px 0;
  color:var(--brand);
  font-size:24px;
  font-weight:700;
}
.gallery-subtitle{
  color:var(--muted);
  font-size:13px;
  margin-bottom:20px;
}
.toolbar{
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:space-between;
  margin-bottom:16px;
}
.right{
  display:flex;
  gap:10px;
  align-items:center;
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
  gap:16px;
  margin-top:16px;
}
.card{
  background:var(--panel2);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  transition:all 0.2s ease;
  cursor:pointer;
}
.card:hover{
  border-color:var(--brand);
  transform:translateY(-2px);
  box-shadow:0 8px 24px rgba(0,217,184,0.15);
}
.thumb{
  width:100%;
  height:170px;
  background:#0b0b0b;
  border:1px solid var(--border);
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
.thumb canvas{
  border-radius:6px;
  max-width:100%;
  max-height:100%;
}
.card-title{
  font-weight:600;
  font-size:14px;
  color:var(--text);
}
.card-desc{
  font-size:11px;
  color:var(--muted);
  line-height:1.4;
}
.card button {
    pointer-events: none; /* Prevents button from interfering with card click */
}

/* Output */
#output{
  white-space:pre;
  background:#0b0b0b;
  border:1px solid var(--border);
  border-radius:8px;
  padding:12px;
  max-height:150px;
  overflow:auto;
  font-family:monospace;
  font-size:11px;
  line-height:1.5;
  color:#6dd3ae;
}

/* Scrollbars */
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-track{background:var(--panel)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:#3a3a3e}
</style>
</head>
<body>

<div class="app">
  <header>
    <div class="brand">kin;D</div>
    <span class="brand-tagline">Display Designer</span>
    <div class="divider"></div>

    <label style="color:#eee">Zoom
      <input type="range" id="zoomSlider" min="25" max="175" value="100">
      <span id="zoomLabel" class="value-pill">100%</span>
    </label>
    <button id="fitBtn" class="tiny">Fit</button>

    <div class="divider"></div>

    <label>Template
      <select id="templateSelect" style="width:160px"></select>
    </label>
    <label>Theme
      <select id="textTheme">
        <option value="dark" selected>Dark</option>
        <option value="light">Light</option>
      </select>
    </label>

    <div style="flex:1"></div>

    <button id="undoBtn" class="tiny" title="Undo (Ctrl+Z)">‚Ü∂ Undo</button>
    <button id="saveTemplateBtn" class="tiny" title="Save template to browser">üíæ Save Template</button>
    <button id="resetTemplateBtn" class="tiny" title="Reset template to default">‚Ü∫ Reset Template</button>
    <button id="publishBtn" class="primary tiny" title="Publish to backend server">‚¨Ü Publish to Cloud</button>
    <button id="advancedBtn" class="tiny" style="margin-left:8px">üîì Advanced</button>
  </header>

  <div class="stage-wrap">
    <div id="zoomStage">
      <div id="canvas">
        <img id="bg" alt="background">
        <svg class="grid-overlay" id="gridOverlay"></svg>
      </div>
    </div>
  </div>

  <div class="sidebar">
    <div class="panel">
      <h3>‚äï Add Elements</h3>
      <div class="row">
        <button id="addBox">‚ñ¢ Box</button>
        <button id="addText">T Text</button>
        <button id="addIcon">‚òÄ Icon</button>
      </div>
      <div class="row">
        <button id="addWeather" class="tiny">üå§ Weather</button>
        <button id="addJoke" class="tiny">üòÑ Joke</button>
        <button id="addDate" class="tiny">üìÖ Date</button>
        <button id="addCity" class="tiny">üèô City</button>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="deleteBtn" class="tiny" style="background:#4a1a1a;border-color:#6a2a2a" title="Delete (Del)">üóë Delete</button>
      </div>
    </div>

    <div class="panel" id="inspectPanel">
      <h3>üîç Inspector</h3>
      <div class="row">
        <span id="inspectType" style="color:var(--brand);font-weight:600">Nothing selected</span>
      </div>
      <div class="row">
        <label>Width
          <input type="number" id="inspectW" min="10" max="800" step="10" style="width:80px" disabled>
        </label>
        <label>Height
          <input type="number" id="inspectH" min="10" max="480" step="10" style="width:80px" disabled>
        </label>
      </div>
    </div>

    <div class="panel" id="textControlPanel">
      <h3>üñã Text & Icon</h3>
      <div class="row">
        <label style="flex:1">Content
          <input type="text" id="textElContent" style="width:100%" disabled>
        </label>
      </div>
      <div class="row">
        <label>Type / Role
          <select id="textElType" style="width:100%" disabled>
            <option value="">Static Text</option>
            <option value="JOKE">Joke</option>
            <option value="DATE">Date</option>
            <option value="WEATHER_CITY">Weather: City</option>
            <option value="WEATHER_MINMAX">Weather: Min/Max</option>
            <option value="WEATHER_NOTE">Weather: Note</option>
            <option value="WEATHER_ICON">Weather: Icon</option>
          </select>
        </label>
      </div>
      <div class="row">
        <label>Font Size
          <input type="range" id="textSize" min="8" max="120" value="16" style="width:140px" disabled>
          <span id="textSizeVal" class="value-pill">16px</span>
        </label>
      </div>
      <div class="row">
        <label>Font Weight
          <select id="fontWeight" style="width:100%" disabled>
            <option value="300">Light (300)</option>
            <option value="400" selected>Regular (400)</option>
            <option value="700">Bold (700)</option>
          </select>
        </label>
      </div>
      <div style="font-size:10px;color:var(--muted);margin-top:4px;line-height:1.3">
        Uses Roboto font family (Light/Regular/Bold)
      </div>
    </div>

    <div class="panel">
      <h3>‚äû Alignment</h3>
      <div class="row">
        <button id="alignLeft" class="tiny" title="Align Left">‚ä£</button>
        <button id="alignCenter" class="tiny" title="Center">‚ä¢‚ä£</button>
        <button id="alignRight" class="tiny" title="Align Right">‚ä¢</button>
        <button id="alignTop" class="tiny" title="Align Top">‚ä§</button>
        <button id="alignMiddle" class="tiny" title="Middle">‚ä•‚ä§</button>
        <button id="alignBottom" class="tiny" title="Align Bottom">‚ä•</button>
      </div>
      <div class="row">
        <label><input type="checkbox" id="snapToGrid"> Snap (16px)</label>
        <button id="toggleGrid" class="tiny">Grid</button>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:8px">
        üí° Select a box, then text/icon to align within
      </div>
    </div>

    <div class="panel">
      <h3>‚ö° Quick Layouts</h3>
      <div class="row">
        <button id="presetBanner" class="tiny">Banner</button>
        <button id="presetQuarter" class="tiny">4 Cards</button>
        <button id="presetSidebar" class="tiny">Sidebar</button>
      </div>
    </div>

    <div class="panel">
      <h3>‚òÅ Backend Configuration</h3>
      <div class="row">
        <label style="flex:1">Backend URL
          <input id="beUrl" type="text" placeholder="https://your-backend.run.app" style="width:100%">
        </label>
      </div>
      <div class="row">
        <label>Device ID
          <input id="beDevice" type="text" value="familydisplay" style="width:100px">
        </label>
        <label>Admin Token
          <input id="beToken" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100px">
        </label>
      </div>
      <div class="row">
        <button id="btnLoadServer" class="tiny">‚¨á Load from Server</button>
      </div>
      <div style="font-size:10px;color:var(--muted);margin-top:8px;line-height:1.4">
        Use <strong>‚¨Ü Publish to Cloud</strong> button in header to save<br>
        Saves to: <code style="color:var(--brand)">layouts/{device}/current.json</code>
      </div>
    </div>

    <div class="panel">
      <h3>üíæ Export / Import</h3>
      <div class="row">
        <button id="btnExport" class="tiny">JSON</button>
        <input type="file" id="importFile" accept=".json" style="display:none">
        <button id="btnImport" class="tiny">Import</button>
        <button id="btnDownloadPNG" class="primary tiny">PNG</button>
      </div>
      <pre id="output"></pre>
    </div>
  </div>

  <div class="status-bar">
    <div class="status-item">
      <span class="status-dot"></span>
      <span>kin;D v4.1 (Fixed)</span>
    </div>
    <div class="status-item"><span>800√ó480 ‚Ä¢ E-ink</span></div>
    <div class="status-item">
      <span>Select elements to see their properties in the inspector.</span>
    </div>
    <div style="flex:1"></div>
    <div class="status-item">
      <span id="statusMsg">Ready</span>
    </div>
  </div>
</div>

<div class="overlay" id="galleryOverlay">
  <div class="gallery">
    <div class="toolbar">
      <div>
        <h2>Choose a Template</h2>
        <div class="gallery-subtitle">Select a starting point for your kin;D display</div>
      </div>
      <div class="right">
        <label>Theme
          <select id="galleryTextTheme">
            <option value="dark" selected>Dark</option>
            <option value="light">Light</option>
          </select>
        </label>
        <button id="galleryAdvanced" class="primary tiny">üîì Advanced</button>
      </div>
    </div>
    <div class="grid" id="templateGrid"></div>
  </div>
</div>

<canvas id="exportCanvas" width="800" height="480" style="display:none"></canvas>

<script>
// ====== INITIALIZATION ======
console.log('‚úÖ kin;D Designer loading...');

const canvas = document.getElementById('canvas');
const bg = document.getElementById('bg');
const statusMsg = document.getElementById('statusMsg');
const templateGrid = document.getElementById('templateGrid');
const galleryOverlay = document.getElementById('galleryOverlay');
const galleryTextTheme = document.getElementById('galleryTextTheme');
const templateSelect = document.getElementById('templateSelect');
const textThemeSelect = document.getElementById('textTheme');
const advancedBtn = document.getElementById('advancedBtn');
const gridOverlay = document.getElementById('gridOverlay');
const snapToGridCheck = document.getElementById('snapToGrid');

// Inspector DOM Elements
const textElContent = document.getElementById('textElContent');
const textElType = document.getElementById('textElType');

let advancedUnlocked = false;
let selected = null;
let selectedBox = null; // Track selected box for alignment within
let currentTemplateKey = null;
let undoStack = [];
const GRID_SIZE = 16;

// Backend sync
const beUrl = document.getElementById('beUrl');
const beDevice = document.getElementById('beDevice');
const beToken = document.getElementById('beToken');

// ====== ELEMENT SELECTION ======
function selectEl(el) {
  document.querySelectorAll('.el.selected').forEach(s => s.classList.remove('selected'));
  selected = el;
  if (selected) selected.classList.add('selected');

  updateInspector();
  detectBoxForAlignment();
}

function getSelectedElements() {
  return [...document.querySelectorAll('.el.selected')];
}

function detectBoxForAlignment() {
  const selectedEls = getSelectedElements();
  if (selectedEls.length !== 1) {
      selectedBox = null;
      return;
  }
  const sel = selectedEls[0];
  if (sel.classList.contains('text') || sel.classList.contains('icon')) {
      const textRect = sel.getBoundingClientRect();
      const boxes = [...canvas.querySelectorAll('.el.box')];
      selectedBox = boxes.find(box => {
          const boxRect = box.getBoundingClientRect();
          return (
              textRect.left >= boxRect.left &&
              textRect.right <= boxRect.right &&
              textRect.top >= boxRect.top &&
              textRect.bottom <= boxRect.bottom &&
              textRect.top <= boxRect.bottom &&
              textRect.left <= boxRect.right
          );
      }) || null;
  } else {
      selectedBox = null;
  }
}

// ====== INSPECTOR PANEL ======
function updateInspector() {
  const selectedEls = getSelectedElements();
  const el = selectedEls.length > 0 ? selectedEls[0] : null;

  // Generic inspector fields
  document.getElementById('inspectType').textContent = el ? (el.classList.contains('box') ? 'Box' : el.classList.contains('icon') ? 'Icon' : 'Text') : 'Nothing selected';
  document.getElementById('inspectW').disabled = !el;
  document.getElementById('inspectH').disabled = !el;
  document.getElementById('inspectW').value = el ? el.offsetWidth : '';
  document.getElementById('inspectH').value = el ? el.offsetHeight : '';

  // Text-specific fields
  const isTextOrIcon = el && (el.classList.contains('text') || el.classList.contains('icon'));
  document.getElementById('textSize').disabled = !isTextOrIcon;
  document.getElementById('fontWeight').disabled = !isTextOrIcon;
  textElContent.disabled = !isTextOrIcon;
  textElType.disabled = !isTextOrIcon;

  if (isTextOrIcon) {
    const style = getComputedStyle(el);
    const fontSize = parseInt(style.fontSize) || 16;
    document.getElementById('textSize').value = fontSize;
    document.getElementById('textSizeVal').textContent = fontSize + 'px';
    document.getElementById('fontWeight').value = style.fontWeight === 'bold' || parseInt(style.fontWeight) >= 700 ? '700' : (parseInt(style.fontWeight) <= 300 ? '300' : '400');
    textElContent.value = el.textContent.trim();
    textElType.value = el.dataset.type || '';
  } else {
    document.getElementById('textSizeVal').textContent = '--';
    document.getElementById('fontWeight').value = '400';
    textElContent.value = '';
    textElType.value = '';
  }
}

// Inspector controls listeners
document.getElementById('inspectW').addEventListener('change', e => {
  if (selected) { saveState(); selected.style.width = e.target.value + 'px'; }
});
document.getElementById('inspectH').addEventListener('change', e => {
  if (selected) { saveState(); selected.style.height = e.target.value + 'px'; }
});
document.getElementById('textSize').addEventListener('input', e => {
  if (selected) { selected.style.fontSize = e.target.value + 'px'; document.getElementById('textSizeVal').textContent = e.target.value + 'px'; }
});
document.getElementById('textSize').addEventListener('change', () => saveState());
document.getElementById('fontWeight').addEventListener('change', e => {
  if (selected) { saveState(); selected.style.fontWeight = e.target.value; }
});
textElContent.addEventListener('input', e => {
  if (selected) { selected.textContent = e.target.value; }
});
textElContent.addEventListener('change', () => saveState());
textElType.addEventListener('change', e => {
  if (selected) { saveState(); selected.dataset.type = e.target.value; }
});


// ====== DYNAMICALLY ENHANCED TEMPLATES (Based on user files and backend types) ======
const TEMPLATES = [
    { key: 'blank_dark', name: 'Blank Canvas (Dark)', desc: 'Start with an empty 800x480 dark canvas.', data: { elements: [] }},
    { key: 'blank_light', name: 'Blank Canvas (Light)', desc: 'Start with an empty 800x480 light canvas.', data: { elements: [] }},
    { key: 'coastal_split_dark', name: 'Coastal Split (Dark)', desc: 'Large banner with dynamic weather, date, and a joke.', data: {
        elements: [
          {kind:"box",x:40,y:340,w:340,h:110},
          {kind:"box",x:420,y:340,w:340,h:110},
          // Weather Icon added for completeness
          {kind:"icon",x:40,y:270,w:50,h:50,text:"‚òÄÔ∏è",color:"#000000",type:"WEATHER_ICON"},
          // City/Temp Combined
          {kind:"text",x:100,y:270,w:280,h:50,text:"Darwin ‚Ä¢ 26¬∞ / 33¬∞",color:"#000000",weight:"700",type:"WEATHER_MINMAX"},
          // Joke
          {kind:"text",x:450,y:360,w:300,h:60,text:"Why don't scientists trust atoms? Because they make up everything!",color:"#000000",weight:"400",type:"JOKE"},
          // Date
          {kind:"text",x:40,y:20,w:200,h:40,text:"Sunday, 26 Oct",color:"#000000",weight:"700",type:"DATE"}
        ]}},
    { key: 'coastal_split_light', name: 'Coastal Split (Light)', desc: 'Large banner with dynamic weather, date, and a joke.', data: {
        elements: [
          {kind:"box",x:40,y:340,w:340,h:110,fill:"rgba(255,255,255,0.7)",border:"1px solid rgba(255,255,255,0.9)"},
          {kind:"box",x:420,y:340,w:340,h:110,fill:"rgba(255,255,255,0.7)",border:"1px solid rgba(255,255,255,0.9)"},
          // Weather Icon added for completeness
          {kind:"icon",x:40,y:270,w:50,h:50,text:"‚òÄÔ∏è",color:"#ffffff",type:"WEATHER_ICON"},
          // City/Temp Combined
          {kind:"text",x:100,y:270,w:280,h:50,text:"Darwin ‚Ä¢ 26¬∞ / 33¬∞",color:"#ffffff",weight:"700",type:"WEATHER_MINMAX"},
          // Joke
          {kind:"text",x:450,y:360,w:300,h:60,text:"Why don't scientists trust atoms? Because they make up everything!",color:"#ffffff",weight:"400",type:"JOKE"},
          // Date
          {kind:"text",x:40,y:20,w:200,h:40,text:"Sunday, 26 Oct",color:"#ffffff",weight:"700",type:"DATE"}
        ]}},
    { key: 'left_rail_dark', name: 'Left Rail (Dark)', desc: 'Vertical weather panel on the left with main content right.', data: {
        elements: [
          {kind:"box",x:20,y:60,w:180,h:360},
          {kind:"text",x:40,y:80,w:140,h:60,text:"Darwin",color:"#000000",weight:"700",type:"WEATHER_CITY"},
          {kind:"text",x:40,y:160,w:140,h:40,text:"26¬∞ / 33¬∞",color:"#000000",type:"WEATHER_MINMAX"},
          {kind:"icon",x:40,y:220,w:140,h:40,text:"‚òÄÔ∏è",color:"#000000",type:"WEATHER_ICON"},
          {kind:"text",x:220,y:380,w:540,h:60,text:"Why don't scientists trust atoms? Because they make up everything!",color:"#000000",type:"JOKE"},
          {kind:"text",x:220,y:40,w:260,h:40,text:"Sunday, 26 Oct",color:"#000000",type:"DATE"}
        ]}},
    { key: 'left_rail_light', name: 'Left Rail (Light)', desc: 'Vertical weather panel on the left with main content right.', data: {
        elements: [
          {kind:"box",x:20,y:60,w:180,h:360,fill:"rgba(255,255,255,0.7)",border:"1px solid rgba(255,255,255,0.9)"},
          {kind:"text",x:40,y:80,w:140,h:60,text:"Darwin",color:"#ffffff",weight:"700",type:"WEATHER_CITY"},
          {kind:"text",x:40,y:160,w:140,h:40,text:"26¬∞ / 33¬∞",color:"#ffffff",type:"WEATHER_MINMAX"},
          {kind:"icon",x:40,y:220,w:140,h:40,text:"‚òÄÔ∏è",color:"#ffffff",type:"WEATHER_ICON"},
          {kind:"text",x:220,y:380,w:540,h:60,text:"Why don't scientists trust atoms? Because they make up everything!",color:"#ffffff",type:"JOKE"},
          {kind:"text",x:220,y:40,w:260,h:40,text:"Sunday, 26 Oct",color:"#ffffff",type:"DATE"}
        ]}},
    { key: 'center_float_dark', name: 'Center Float (Dark)', desc: 'Weather and Date centered in a glassmorphic box.', data: {
        elements: [
          {kind:"box",x:200,y:160,w:400,h:160},
          {kind:"text",x:240,y:180,w:320,h:60,text:"Darwin ‚Ä¢ 26¬∞ / 33¬∞",color:"#000000",weight:"700",type:"WEATHER_MINMAX"},
          {kind:"text",x:240,y:250,w:320,h:60,text:"Date/Time",color:"#000000",type:"DATE"},
          {kind:"text",x:180,y:360,w:440,h:60,text:"Why don't scientists trust atoms? Because they make up everything!",color:"#000000",type:"JOKE"}
        ]}},
    { key: 'center_float_light', name: 'Center Float (Light)', desc: 'Weather and Date centered in a glassmorphic box.', data: {
        elements: [
          {kind:"box",x:200,y:160,w:400,h:160,fill:"rgba(255,255,255,0.7)",border:"1px solid rgba(255,255,255,0.9)"},
          {kind:"text",x:240,y:180,w:320,h:60,text:"Darwin ‚Ä¢ 26¬∞ / 33¬∞",color:"#ffffff",weight:"700",type:"WEATHER_MINMAX"},
          {kind:"text",x:240,y:250,w:320,h:60,text:"Date/Time",color:"#ffffff",type:"DATE"},
          {kind:"text",x:180,y:360,w:440,h:60,text:"Why don't scientists trust atoms? Because they make up everything!",color:"#ffffff",type:"JOKE"}
        ]}},
    { key: 'top_bar_dark', name: 'Top Bar Breeze (Dark)', desc: 'Horizontal bar at the top for primary information.', data: {
        elements: [
          {kind:"box",x:20,y:20,w:760,h:80},
          {kind:"text",x:40,y:40,w:260,h:40,text:"Darwin ‚Ä¢ 26¬∞ / 33¬∞",color:"#000000",weight:"700",type:"WEATHER_MINMAX"},
          {kind:"text",x:320,y:40,w:260,h:40,text:"Date/Time",color:"#000000",type:"DATE"},
          {kind:"icon",x:620,y:40,w:140,h:40,text:"‚òÄÔ∏è",color:"#000000",type:"WEATHER_ICON"},
          {kind:"text",x:200,y:380,w:400,h:60,text:"Why don't scientists trust atoms? Because they make up everything!",color:"#000000",type:"JOKE"}
        ]}},
    { key: 'top_bar_light', name: 'Top Bar Breeze (Light)', desc: 'Horizontal bar at the top for primary information.', data: {
        elements: [
          {kind:"box",x:20,y:20,w:760,h:80,fill:"rgba(255,255,255,0.7)",border:"1px solid rgba(255,255,255,0.9)"},
          {kind:"text",x:40,y:40,w:260,h:40,text:"Darwin ‚Ä¢ 26¬∞ / 33¬∞",color:"#ffffff",weight:"700",type:"WEATHER_MINMAX"},
          {kind:"text",x:320,y:40,w:260,h:40,text:"Date/Time",color:"#ffffff",type:"DATE"},
          {kind:"icon",x:620,y:40,w:140,h:40,text:"‚òÄÔ∏è",color:"#ffffff",type:"WEATHER_ICON"},
          {kind:"text",x:200,y:380,w:400,h:60,text:"Why don't scientists trust atoms? Because they make up everything!",color:"#ffffff",type:"JOKE"}
        ]}},
    { key: 'minimal_column_dark', name: 'Minimal Column (Dark)', desc: 'Stacked vertical info panel.', data: {
        elements: [
          {kind:"box",x:220,y:100,w:360,h:280},
          {kind:"text",x:260,y:130,w:280,h:60,text:"Darwin ‚Ä¢ 26¬∞ / 33¬∞",color:"#000000",weight:"700",type:"WEATHER_MINMAX"},
          {kind:"text",x:260,y:210,w:280,h:80,text:"Why don't scientists trust atoms? Because they make up everything!",color:"#000000",type:"JOKE"},
          {kind:"text",x:260,y:310,w:260,h:40,text:"Date/Time",color:"#000000",type:"DATE"}
        ]}},
    { key: 'minimal_column_light', name: 'Minimal Column (Light)', desc: 'Stacked vertical info panel.', data: {
        elements: [
          {kind:"box",x:220,y:100,w:360,h:280,fill:"rgba(255,255,255,0.7)",border:"1px solid rgba(255,255,255,0.9)"},
          {kind:"text",x:260,y:130,w:280,h:60,text:"Darwin ‚Ä¢ 26¬∞ / 33¬∞",color:"#ffffff",weight:"700",type:"WEATHER_MINMAX"},
          {kind:"text",x:260,y:210,w:280,h:80,text:"Why don't scientists trust atoms? Because they make up everything!",color:"#ffffff",type:"JOKE"},
          {kind:"text",x:260,y:310,w:260,h:40,text:"Date/Time",color:"#ffffff",type:"DATE"}
        ]}}
];

// ====== HELPER FUNCTIONS ======
function setStatus(msg, duration = 3000) {
  statusMsg.textContent = msg;
  if (duration > 0) setTimeout(() => statusMsg.textContent = 'Ready', duration);
}
function parsePx(v) { return parseFloat(v) || 0; }
function snapToGrid(val) { return snapToGridCheck.checked ? Math.round(val / GRID_SIZE) * GRID_SIZE : val; }

function saveState() {
  undoStack.push(getCurrentLayoutJSON(true));
  if (undoStack.length > 30) undoStack.shift();
  document.getElementById('undoBtn').disabled = false;
}

function undo() {
  if (undoStack.length <= 1) return;
  undoStack.pop(); // pop current state
  const state = undoStack[undoStack.length - 1]; // get previous state
  clearCanvas();
  renderLayout(state);
  document.getElementById('undoBtn').disabled = (undoStack.length <= 1);
  setStatus('Undone', 1500);
}

// ====== GRID DRAWING ======
function drawGrid() {
  const svg = gridOverlay;
  svg.setAttribute('width', '800');
  svg.setAttribute('height', '480');
  svg.innerHTML = '';
  for (let x = GRID_SIZE; x < 800; x += GRID_SIZE) {
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', x); line.setAttribute('y1', 0); line.setAttribute('x2', x); line.setAttribute('y2', 480);
    svg.appendChild(line);
  }
  for (let y = GRID_SIZE; y < 480; y += GRID_SIZE) {
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', 0); line.setAttribute('y1', y); line.setAttribute('x2', 800); line.setAttribute('y2', y);
    svg.appendChild(line);
  }
}
drawGrid();
document.getElementById('toggleGrid').onclick = () => gridOverlay.classList.toggle('active');

// ====== ELEMENT MANAGEMENT ======
function makeEl(cls, x = 50, y = 50, w = 160, h = 80) {
  const el = document.createElement('div');
  el.className = 'el ' + cls;
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  el.style.width = w + 'px';
  el.style.height = h + 'px';
  el.appendChild(document.createElement('div')).className = 'resize-handle';
  canvas.appendChild(el);
  return el;
}

function clearCanvas() {
  [...canvas.children].forEach(n => {
    if (n.classList.contains('el')) n.remove();
  });
}

function renderLayout(data) {
  clearCanvas();
  (data.elements || []).forEach(elData => {
    const div = makeEl(elData.kind || 'box', elData.x, elData.y, elData.w, elData.h);
    if (elData.text) div.textContent = elData.text;
    if (elData.color) div.style.color = elData.color;
    if (elData.weight) div.style.fontWeight = elData.weight;
    if (elData.type) div.dataset.type = elData.type;
    if (elData.kind === 'text' || elData.kind === 'icon') {
        div.style.fontSize = Math.max(12, Math.floor(elData.h * 0.6)) + 'px';
    }
  });
  selectEl(null); // Clear selection after loading new layout
  saveState();
}

// ====== DRAG AND RESIZE ======
let dragData = null;
let resizeData = null;
canvas.addEventListener('mousedown', e => {
  if (!advancedUnlocked) return;
  const handle = e.target.closest('.resize-handle');
  const targetEl = e.target.closest('.el');

  if (handle) {
    const el = handle.parentElement;
    selectEl(el);
    resizeData = { el, startX: e.clientX, startY: e.clientY, startW: el.offsetWidth, startH: el.offsetHeight };
    e.stopPropagation();
  } else if (targetEl) {
    selectEl(targetEl);
    const rect = targetEl.getBoundingClientRect();
    const zoom = parseFloat(document.getElementById('zoomSlider').value) / 100;
    dragData = { el: targetEl, dx: (e.clientX - rect.left) / zoom, dy: (e.clientY - rect.top) / zoom };
  } else {
    selectEl(null);
  }
});
window.addEventListener('mousemove', e => {
  const zoom = parseFloat(document.getElementById('zoomSlider').value) / 100;
  if (resizeData) {
    const { el, startX, startY, startW, startH } = resizeData;
    let newW = Math.max(20, startW + (e.clientX - startX) / zoom);
    let newH = Math.max(20, startH + (e.clientY - startY) / zoom);
    if (snapToGridCheck.checked) {
        newW = snapToGrid(newW);
        newH = snapToGrid(newH);
    }
    el.style.width = newW + 'px';
    el.style.height = newH + 'px';
    if (el.classList.contains('text') || el.classList.contains('icon')) {
      const newSize = Math.max(8, Math.floor(newH * 0.6));
      el.style.fontSize = newSize + 'px';
    }
    updateInspector();
  } else if (dragData) {
    const { el, dx, dy } = dragData;
    const canvasRect = canvas.getBoundingClientRect();
    let nx = (e.clientX - canvasRect.left) / zoom - dx;
    let ny = (e.clientY - canvasRect.top) / zoom - dy;
    nx = Math.max(0, Math.min(nx, 800 - el.offsetWidth));
    ny = Math.max(0, Math.min(ny, 480 - el.offsetHeight));
    el.style.left = snapToGrid(nx) + 'px';
    el.style.top = snapToGrid(ny) + 'px';
  }
});
window.addEventListener('mouseup', () => {
  if (dragData || resizeData) saveState();
  dragData = resizeData = null;
});

// ====== ADD ELEMENT BUTTONS (Icon placeholder updated to ‚òÄÔ∏è) ======
function addElement(kind, options = {}) {
  saveState();
  const el = makeEl(kind, options.x ?? 100, options.y ?? 100, options.w ?? 150, options.h ?? 50);
  el.textContent = options.text ?? kind.charAt(0).toUpperCase() + kind.slice(1);
  if (options.fontSize) el.style.fontSize = options.fontSize;
  if (options.fontWeight) el.style.fontWeight = options.fontWeight;
  if (options.type) el.dataset.type = options.type;
  if (kind === 'text' || kind === 'icon') {
      el.style.fontSize = Math.max(12, Math.floor((options.h ?? 50) * 0.6)) + 'px';
  }
  selectEl(el);
  setStatus(`${el.textContent} element added`, 1500);
}
document.getElementById('addBox').onclick = () => addElement('box', {w:300, h:120, text:''});
document.getElementById('addText').onclick = () => addElement('text', {w:180, h:44});
document.getElementById('addIcon').onclick = () => addElement('icon', {w:64, h:64, text:'‚òÄÔ∏è', type: 'WEATHER_ICON'});
document.getElementById('addWeather').onclick = () => addElement('text', {y:380, w:200, h:30, text:'26¬∞ / 33¬∞', type:'WEATHER_MINMAX'});
document.getElementById('addJoke').onclick = () => addElement('text', {x:420, y:380, w:340, h:70, text:'Joke Placeholder', type:'JOKE'});
document.getElementById('addDate').onclick = () => addElement('text', {x:540, y:40, w:200, h:30, text:'Mon, 27 Oct', fontWeight:'700', type:'DATE'});
document.getElementById('addCity').onclick = () => addElement('text', {y:350, w:150, h:35, text:'Darwin', fontWeight:'700', type:'WEATHER_CITY'});
document.getElementById('deleteBtn').onclick = () => { if (selected) { saveState(); selected.remove(); selectEl(null); setStatus('Deleted', 1500); } };

// ====== ALIGNMENT TOOLS ======
const align = (prop, valueFn) => () => {
    const els = getSelectedElements(); if (!els.length) return; saveState();
    els.forEach(el => { el.style[prop] = valueFn(el) + 'px'; });
    setStatus(`Aligned ${prop}`, 1500);
};
document.getElementById('alignLeft').onclick = align('left', el => selectedBox ? parsePx(selectedBox.style.left) + 10 : 20);
document.getElementById('alignCenter').onclick = align('left', el => selectedBox ? parsePx(selectedBox.style.left) + (selectedBox.offsetWidth - el.offsetWidth) / 2 : (800 - el.offsetWidth) / 2);
document.getElementById('alignRight').onclick = align('left', el => selectedBox ? parsePx(selectedBox.style.left) + selectedBox.offsetWidth - el.offsetWidth - 10 : 800 - el.offsetWidth - 20);
document.getElementById('alignTop').onclick = align('top', el => selectedBox ? parsePx(selectedBox.style.top) + 10 : 20);
document.getElementById('alignMiddle').onclick = align('top', el => selectedBox ? parsePx(selectedBox.style.top) + (selectedBox.offsetHeight - el.offsetHeight) / 2 : (480 - el.offsetHeight) / 2);
document.getElementById('alignBottom').onclick = align('top', el => selectedBox ? parsePx(selectedBox.style.top) + selectedBox.offsetHeight - el.offsetHeight - 10 : 480 - el.offsetHeight - 20);

// ====== QUICK LAYOUTS ======
function applyPreset(elements) { saveState(); renderLayout({elements}); }
document.getElementById('presetBanner').onclick = () => applyPreset([{kind:'box',x:0,y:0,w:800,h:80}]);
document.getElementById('presetQuarter').onclick = () => applyPreset([
    {kind:'box',x:20,y:20,w:370,h:210}, {kind:'box',x:410,y:20,w:370,h:210},
    {kind:'box',x:20,y:250,w:370,h:210}, {kind:'box',x:410,y:250,w:370,h:210}
]);
document.getElementById('presetSidebar').onclick = () => applyPreset([
    {kind:'box',x:20,y:20,w:220,h:440}, {kind:'box',x:260,y:20,w:520,h:440}
]);

// ====== ADVANCED MODE & KEYBOARD ======
advancedBtn.onclick = () => {
  advancedUnlocked = !advancedUnlocked;
  advancedBtn.textContent = advancedUnlocked ? 'üîí Lock' : 'üîì Advanced';
  advancedBtn.classList.toggle('primary', !advancedUnlocked);
  setStatus(`Advanced mode ${advancedUnlocked ? 'ON' : 'OFF'}`, 2000);
};
document.addEventListener('keydown', e => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
  if (!advancedUnlocked) return;
  if (e.key === 'Delete' || e.key === 'Backspace') { e.preventDefault(); document.getElementById('deleteBtn').click(); }
  if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
});
document.getElementById('undoBtn').onclick = undo;

// ====== ZOOM CONTROLS ======
document.getElementById('zoomSlider').addEventListener('input', e => {
  const z = e.target.value / 100;
  document.getElementById('zoomStage').style.transform = `scale(${z})`;
  document.getElementById('zoomLabel').textContent = e.target.value + '%';
});
document.getElementById('fitBtn').onclick = () => {
  const stageWrap = document.querySelector('.stage-wrap');
  const zw = (stageWrap.clientWidth - 40) / 800;
  const zh = (stageWrap.clientHeight - 40) / 480;
  document.getElementById('zoomSlider').value = Math.min(zw, zh) * 100;
  document.getElementById('zoomSlider').dispatchEvent(new Event('input'));
};

// ====== EXPORT JSON (NOW INCLUDES TYPE) ======
function getCurrentLayoutJSON(forUndo = false) {
  const els = [...canvas.querySelectorAll('.el')].map(el => {
    const style = getComputedStyle(el);
    const obj = {
      kind: el.className.replace('el ', '').replace(' selected', '').trim(),
      x: Math.round(parsePx(el.style.left)),
      y: Math.round(parsePx(el.style.top)),
      w: el.offsetWidth,
      h: el.offsetHeight,
      text: el.textContent.trim(),
      color: style.color,
      weight: style.fontWeight
    };
    if (el.dataset.type) {
      obj.type = el.dataset.type;
    }
    return obj;
  });
  const layout = { elements: els };
  if (!forUndo) {
    layout.device = beDevice.value.trim() || 'familydisplay';
    layout.mode = 'sticker_parade';
  }
  return layout;
}

// ====== IMPORT/EXPORT & PNG ======
document.getElementById('btnExport').onclick = () => {
  const data = JSON.stringify(getCurrentLayoutJSON(), null, 2);
  document.getElementById('output').textContent = data;
  const blob = new Blob([data], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${currentTemplateKey || 'custom'}-layout.json`;
  a.click();
  setStatus('Exported JSON', 1500);
};
document.getElementById('btnImport').onclick = () => document.getElementById('importFile').click();
document.getElementById('importFile').onchange = e => {
  const f = e.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const json = JSON.parse(e.target.result);
      renderLayout(json);
      setStatus('Imported', 1500);
    } catch { setStatus('Invalid JSON', 2000); }
  };
  reader.readAsText(f);
};
document.getElementById('btnDownloadPNG').onclick = () => {
  const ex = document.getElementById('exportCanvas');
  const ctx = ex.getContext('2d');
  ctx.clearRect(0, 0, 800, 480);
  const bgImg = document.getElementById('bg');
  if(bgImg.complete) ctx.drawImage(bgImg, 0, 0, 800, 480);
  
  const els = [...canvas.querySelectorAll('.el')];
  els.forEach(el => {
    const x = parsePx(el.style.left), y = parsePx(el.style.top), w = el.offsetWidth, h = el.offsetHeight;
    if (el.classList.contains('box')) {
      ctx.fillStyle = 'rgba(255,255,255,0.2)';
      ctx.strokeStyle = 'rgba(200,200,200,0.8)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.roundRect(x, y, w, h, 12);
      ctx.fill();
      ctx.stroke();
    } else {
      const style = getComputedStyle(el);
      ctx.fillStyle = style.color;
      ctx.font = `${style.fontWeight} ${style.fontSize} ${style.fontFamily}`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(el.textContent.trim(), x + w / 2, y + h / 2);
    }
  });

  const a = document.createElement('a');
  a.download = 'kind-layout.png';
  a.href = ex.toDataURL('image/png');
  a.click();
  setStatus('PNG downloaded', 1500);
};

// ====== BACKEND SYNC ======
async function fetchFromBackend(url, options = {}) {
  setStatus('Connecting...', 0);
  try {
    const res = await fetch(url, { mode: 'cors', ...options });
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
    return await res.json();
  } catch (err) {
    alert(`Request Failed: ${err.message}\n\nCheck:\n‚Ä¢ Backend URL is correct\n‚Ä¢ Server is running\n‚Ä¢ CORS is enabled on backend`);
    setStatus(`Error: ${err.message}`, 5000);
    throw err;
  }
}
document.getElementById('btnLoadServer').onclick = async () => {
  const base = beUrl.value.trim().replace(/\/$/, '');
  const dev = beDevice.value.trim();
  if (!base || !dev) return alert('Enter backend URL & device ID');
  const data = await fetchFromBackend(`${base}/layouts/${dev}`);
  renderLayout(data);
  setStatus('Loaded from server ‚úì', 2000);
};
document.getElementById('publishBtn').onclick = async () => {
  const base = beUrl.value.trim().replace(/\/$/, '');
  const dev = beDevice.value.trim();
  const tok = beToken.value.trim();
  if (!base || !dev) return alert('Enter backend URL & device ID');
  if (confirm(`Publish layout to device "${dev}"?`)) {
    const layoutData = getCurrentLayoutJSON();
    await fetchFromBackend(`${base}/admin/layouts/${dev}?token=${encodeURIComponent(tok)}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(layoutData)
    });
    setStatus(`‚úÖ Published to cloud!`, 3000);
  }
};

// ====== GALLERY & TEMPLATES ======
function buildGallery() {
  templateGrid.innerHTML = '';
  TEMPLATES.forEach(tpl => {
    const card = document.createElement('div');
    card.className = 'card';
    card.setAttribute('data-template-key', tpl.key); // Add key for identification
    card.innerHTML = `<div class="thumb"><canvas width="240" height="144"></canvas></div>
      <div class="card-title">${tpl.name}</div>
      <div class="card-desc">${tpl.desc}</div>
      <button class="tiny primary" style="width:100%">Use Template</button>`;
    
    // FIX: Make the entire card clickable
    card.onclick = () => { 
        galleryOverlay.style.display = 'none'; 
        applyTemplate(tpl.key); 
    };

    templateGrid.appendChild(card);
    drawPreview(card.querySelector('canvas'), tpl);
  });
}
function drawPreview(cv, tpl) {
    const ctx = cv.getContext('2d');
    const scale = cv.width / 800;
    const g = ctx.createLinearGradient(0, 0, cv.width, cv.height);
    g.addColorStop(0, '#2d2f55'); g.addColorStop(1, '#9ad1c8');
    ctx.fillStyle = g; ctx.fillRect(0, 0, cv.width, cv.height);
    ctx.fillStyle = 'rgba(255,255,255,.25)';
    ctx.strokeStyle = 'rgba(220,220,220,0.9)';
    ctx.lineWidth = 1;
    (tpl.data.elements || []).forEach(el => {
        if (el.kind === 'box') {
            ctx.beginPath();
            ctx.roundRect(el.x * scale, el.y * scale, el.w * scale, el.h * scale, 6 * scale);
            ctx.fill(); ctx.stroke();
        } else if (el.kind === 'text' || el.kind === 'icon') {
            const fontScale = el.kind === 'icon' ? 0.45 : 0.6;
            ctx.fillStyle = el.color || '#000000';
            ctx.font = `${el.weight || '400'} ${Math.max(12, Math.floor((el.h || 50) * fontScale * scale))}px system-ui`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            let text = el.text || el.type || 'TEXT';
            if (el.type) text = el.type.replace('_', ' ').replace(/^(WEATHER)\s/, 'W: ');
            if (text.length > 15) text = text.substring(0, 15) + '...';
            ctx.fillText(text, (el.x + el.w/2) * scale, (el.y + el.h/2) * scale);
        }
    });
}
async function applyTemplate(key) {
  const tpl = TEMPLATES.find(t => t.key === key);
  if (!tpl) return;
  currentTemplateKey = key;
  templateSelect.value = key;
  renderLayout(tpl.data);
  undoStack = []; saveState(); // Reset undo stack with new template
  setStatus(`Template: ${tpl.name}`, 2000);
}
templateSelect.onchange = () => applyTemplate(templateSelect.value);
TEMPLATES.forEach(p => {
  const o = document.createElement('option');
  o.value = p.key; o.textContent = p.name;
  templateSelect.appendChild(o);
});
document.getElementById('saveTemplateBtn').onclick = () => {
  if (!currentTemplateKey) return alert('Select a template first to save over it.');
  localStorage.setItem(`kind_template_${currentTemplateKey}`, JSON.stringify(getCurrentLayoutJSON()));
  setStatus('Template saved to browser', 1500);
};

// ====== BACKGROUND & STARTUP ======
(function drawBg() {
  const c = document.createElement('canvas'); c.width = 800; c.height = 480;
  const ctx = c.getContext('2d'); const g = ctx.createLinearGradient(0, 0, 800, 480);
  g.addColorStop(0, '#2d2f55'); g.addColorStop(0.5, '#4a99a7'); g.addColorStop(1, '#9ad1c8');
  ctx.fillStyle = g; ctx.fillRect(0, 0, 800, 480);
  bg.src = c.toDataURL();
})();
function start() {
  const u = new URL(location.href);
  if (u.searchParams.get('backend')) beUrl.value = u.searchParams.get('backend');
  if (u.searchParams.get('device')) beDevice.value = u.searchParams.get('device');
  if (u.searchParams.get('token')) beToken.value = u.searchParams.get('token');

  buildGallery();
  galleryOverlay.style.display = 'flex';
  document.getElementById('galleryAdvanced').onclick = () => {
    galleryOverlay.style.display = 'none';
    if (!advancedUnlocked) advancedBtn.click();
  };
  applyTemplate('coastal_split_dark'); // Default to the first coastal split template
  setStatus('kin;D Designer ready ‚úì', 2000);
}
start();
</script>
</body>
</html>
