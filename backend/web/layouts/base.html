<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kin:D Base Layout</title>
<style>
  html,body { margin:0; background:#000; }
  #canvas { position:relative; width:800px; height:480px; margin:0 auto; background:#111; overflow:hidden; }
  #bg { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
  body[data-mode="render"] .ui-only { display:none !important; }

  .card {
    position:absolute; border-radius:18px;
    background:rgba(255,255,255,0.22);
    border:1px solid rgba(255,255,255,0.45);
    padding:12px 16px; color:#000;
    display:flex; align-items:center; justify-content:center; line-height:1.1;
  }
  .chip {
    position:absolute; border-radius:999px;
    background:rgba(255,255,255,0.25);
    border:1px solid rgba(255,255,255,0.5);
    padding:6px 12px; color:#000; font-weight:700;
    display:flex; align-items:center; justify-content:center;
  }
</style>
<body>
<div id="canvas">
  <img id="bg" alt="">
  <div id="cardWeather" class="card" style="left:40px; top:340px; width:340px; height:110px; font-size:28px;">--</div>
  <div id="chipDate" class="chip" style="left:620px; top:24px; font-size:18px;">--</div>
  <div id="cardJoke" class="card" style="left:420px; top:340px; width:340px; height:110px; font-size:18px; padding:16px;">--</div>
</div>

<script>
  const params = new URLSearchParams(location.search);
  if (params.get('mode') === 'render') document.body.dataset.mode = 'render';

  const backend = params.get('backend') || location.origin;
  const device  = params.get('device')  || 'familydisplay';
  const theme   = params.get('theme')   || 'abstract';

  async function hydrate(){
    const r = await fetch(`${backend}/v1/render_data?device=${encodeURIComponent(device)}&theme=${encodeURIComponent(theme)}`, {cache:'no-store'});
    const d = await r.json();

    // background
    const bg = document.getElementById('bg');
    const bgUrl = d.pexels_bg_url || '';
    bg.src = bgUrl.startsWith('http') ? bgUrl : `${backend}${bgUrl}`;

    // date chip
    const dt = new Date(d.date || Date.now());
    document.getElementById('chipDate').textContent =
      dt.toLocaleDateString(undefined, { weekday:'short', day:'2-digit', month:'short' });

    // weather card
    const w = d.weather || {};
    document.getElementById('cardWeather').textContent =
      `${d.city || '—'} • ${w.min ?? '–'}° / ${w.max ?? '–'}° ${w.desc ? '('+w.desc+')' : ''}`;

    // joke
    document.getElementById('cardJoke').textContent = d.dad_joke || '';
  }
  hydrate();
</script>
</body>