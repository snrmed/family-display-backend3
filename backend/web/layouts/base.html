<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Kin;D Frame</title>
  <meta name="viewport" content="width=800, height=480, initial-scale=1.0" />
  <link rel="stylesheet" href="/fonts/fonts.css" />
  <style>
    :root {
      --bg: #111;
      --card: rgba(235,235,235,1);
      --text: #000;
      --radius: 18px;
      --pad: 18px;
      --small: 15px;
    }
    body {
      margin: 0;
      background: var(--bg);
      width: 800px;
      height: 480px;
      overflow: hidden;
      font-family: "Inter", system-ui, -apple-system, "Noto Sans", sans-serif;
      position: relative;
    }
    #bgImg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none; /* shown only if we actually have a src */
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: var(--pad);
      color: var(--text);
      box-sizing: border-box;
    }
    #weatherCard {
      position: absolute;
      left: 16px;
      bottom: 80px;
      width: 380px;
      min-height: 90px;
    }
    #jokeCard {
      position: absolute;
      right: 16px;
      bottom: 16px;
      width: 420px;
    }
    #topBtn {
      position: absolute;
      right: 16px;
      top: 16px;
      width: 48px;
      height: 48px;
      border-radius: 16px;
      background: rgba(230,230,230,1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 26px;
      color: #000;
    }
    .title {
      font-weight: 600;
      margin-bottom: 6px;
    }
    .small {
      font-size: var(--small);
    }
  </style>
</head>
<body>
  <img id="bgImg" alt="background" />

  <div id="topBtn">–</div>

  <div id="weatherCard" class="card">
    <div class="title" id="cityEl">--</div>
    <div id="tempEl">• --°C</div>
    <div id="humidityEl" class="small">Humidity: --%</div>
    <div id="windEl" class="small"></div>
    <div id="rainEl" class="small"></div>
  </div>

  <div id="jokeCard" class="card">
    <div id="jokeEl">No joke today.</div>
  </div>

  <script>
    // ---------- helpers ----------
    function getQueryData() {
      try {
        const qs = new URLSearchParams(window.location.search);
        const raw = qs.get("data");
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (e) {
        console.warn("Failed to parse ?data=", e);
        return null;
      }
    }

    function applyData(data) {
      if (!data) return;

      const cityEl = document.getElementById("cityEl");
      const tempEl = document.getElementById("tempEl");
      const humEl  = document.getElementById("humidityEl");
      const windEl = document.getElementById("windEl");
      const rainEl = document.getElementById("rainEl");
      const jokeEl = document.getElementById("jokeEl");
      const bgImg  = document.getElementById("bgImg");

      // city
      cityEl.textContent = data.city || "—";

      // weather
      const w = data.weather || {};
      tempEl.textContent = "• " + (w.temp !== undefined ? w.temp : "—") + "°C";
      humEl.textContent  = "Humidity: " + (w.humidity !== undefined ? w.humidity : "—") + "%";

      if (w.wind !== undefined) {
        // openweather returns m/s -> we convert to km/h if it's small
        let v = w.wind;
        if (v < 30) v = Math.round(v * 3.6);
        windEl.textContent = "Wind: " + v + " km/h";
      } else {
        windEl.textContent = "";
      }

      if (w.rain !== undefined) {
        rainEl.textContent = "Rain: " + (w.rain > 0 ? w.rain + " mm" : "No rain");
      } else {
        rainEl.textContent = "";
      }

      // joke
      jokeEl.textContent = data.dad_joke || "No joke today.";

      // background (optional — only show if provided)
      // for now we look at data.bg or data.image_url or data.theme_image
      const bgSrc = data.bg || data.image_url || data.theme_image;
      if (bgSrc) {
        bgImg.src = bgSrc;
        bgImg.style.display = "block";
      } else {
        bgImg.style.display = "none";
      }
    }

    async function fetchFromBackend() {
      // this path only runs when you're testing in the browser
      // from Cloud Run, Playwright will ALWAYS use ?data=...
      try {
        // try same-origin first
        const res = await fetch("/v1/render_data?device=familydisplay");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const j = await res.json();
        applyData(j);
      } catch (e) {
        console.warn("Backend fetch failed, leaving placeholders.", e);
      }
    }

    // ---------- app entry ----------
    (function start() {
      const injected = getQueryData();
      if (injected) {
        // this is the Playwright /v1/frame path
        applyData(injected);
      } else {
        // this is when you open https://.../backend/web/layouts/base.html in a browser
        fetchFromBackend();
      }
    })();
  </script>
</body>
</html>