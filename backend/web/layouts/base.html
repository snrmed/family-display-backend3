<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kin;D Display Renderer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 800px;
      height: 480px;
      overflow: hidden;
      background: var(--bg, #fff);
      font-family: "Inter", sans-serif;
      color: #000;
    }
    .el {
      position: absolute;
      box-sizing: border-box;
    }
    .card {
      background: rgba(255,255,255,0.8);
      border-radius: 16px;
      padding: 10px 14px;
      font-size: 18px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- Fallback default cards -->
  <div id="fallback" style="display:none;">
    <div id="dateCard" class="card" style="top:20px;left:20px;">Date</div>
    <div id="weatherCard" class="card" style="top:80px;left:20px;">Weather</div>
    <div id="jokeCard" class="card" style="bottom:20px;left:20px;right:20px;">Joke</div>
  </div>

  <script>
  async function main() {
    const params = new URLSearchParams(window.location.search);
    const device = params.get("device") || "familydisplay";
    const dataUrl = `/v1/render_data?device=${device}`;
    const layoutUrl = `/layouts/${device}`;

    const [dataRes, layoutRes] = await Promise.allSettled([
      fetch(dataUrl),
      fetch(layoutUrl)
    ]);

    let renderData = {};
    let layout = null;

    if (dataRes.status === "fulfilled" && dataRes.value.ok) {
      renderData = await dataRes.value.json();
    }
    if (layoutRes.status === "fulfilled" && layoutRes.value.ok) {
      layout = await layoutRes.value.json();
    }

    if (layout && layout.elements && layout.elements.length) {
      renderLayout(layout.elements, renderData);
    } else {
      document.getElementById("fallback").style.display = "block";
      applyFallback(renderData);
    }
  }

  function renderLayout(elements, data) {
    const root = document.getElementById("root");
    root.innerHTML = "";
    for (const el of elements) {
      const div = document.createElement("div");
      div.classList.add("el");
      div.style.left = (el.x || 0) + "px";
      div.style.top = (el.y || 0) + "px";
      div.style.width = (el.w || 100) + "px";
      div.style.height = (el.h || 40) + "px";
      div.style.fontSize = (el.fontSize || 18) + "px";
      div.style.fontWeight = el.fontWeight || "500";
      div.style.color = el.color || "#000";

      if (el.kind === "text") {
        div.textContent = el.text || "";
      }
      else if (el.kind === "date") {
        div.textContent = data.date || "—";
      }
      else if (el.kind === "city") {
        div.textContent = data.city || "—";
      }
      else if (el.kind === "temp") {
        div.textContent = (data.weather?.temp ?? "--") + "°C";
      }
      else if (el.kind === "weather-desc") {
        div.textContent = data.weather?.desc || "—";
      }
      else if (el.kind === "humidity") {
        div.textContent = "Humidity: " + (data.weather?.humidity ?? "--") + "%";
      }
      else if (el.kind === "wind") {
        const kmh = Math.round((data.weather?.wind ?? 0) * 3.6);
        div.textContent = "Wind: " + kmh + " km/h";
      }
      else if (el.kind === "rain") {
        const rain = data.weather?.rain ?? 0;
        div.textContent = rain > 0 ? "Rain: " + rain + " mm" : "";
      }
      else if (el.kind === "joke") {
        div.textContent = data.dad_joke || "";
      }

      root.appendChild(div);
    }
  }

  function applyFallback(data) {
    const d = data || {};
    document.getElementById("dateCard").textContent = d.date || "—";
    if (d.weather) {
      const w = d.weather;
      document.getElementById("weatherCard").textContent =
        `${w.temp}°C ${w.desc || ""}, humidity ${w.humidity || "--"}%`;
    }
    document.getElementById("jokeCard").textContent = d.dad_joke || "";
  }

  main();
  </script>
</body>
</html>
